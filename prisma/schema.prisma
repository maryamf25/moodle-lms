generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  student
  parent
  school
}

enum AdminAction {
  USER_SUSPENDED
  USER_UNSUSPENDED
  PASSWORD_RESET
  ROLE_ASSIGNED
  COURSES_SYNCED
  COURSE_PRICING_UPDATED
  COURSE_CATEGORY_UPDATED
  COURSE_VISIBILITY_UPDATED
}

enum CouponType {
  PERCENTAGE
  FIXED
}

enum SupportTicketCategory {
  TECHNICAL
  BILLING
  COURSE_ISSUE
  ACCOUNT
  OTHER
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_USER
  RESOLVED
  CLOSED
}

model User {
  id           String   @id @default(cuid())
  moodleUserId Int      @unique
  username     String
  email        String?
  firstName    String?
  lastName     String?
  role         UserRole @default(student)
  isSuspended  Boolean  @default(false)
  lastPasswordResetAt DateTime?
  passwordResetCount Int @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime?
  adminActionsPerformed AdminActivityLog[] @relation("AdminActivityActor")
  adminActionsTargeted  AdminActivityLog[] @relation("AdminActivityTarget")
  cartItems    CartItem[]
  createdSupportTickets SupportTicket[] @relation("SupportTicketCreatedBy")
  assignedSupportTickets SupportTicket[] @relation("SupportTicketAssignedTo")
  lastReplySupportTickets SupportTicket[] @relation("SupportTicketLastReplyBy")
  supportTicketMessages SupportTicketMessage[] @relation("SupportTicketMessageAuthor")
  supportTicketAttachments SupportTicketAttachment[] @relation("SupportTicketAttachmentUploader")
  supportTicketNotifications SupportTicketNotification[]

  @@index([role])
  @@index([isSuspended])
}

model CourseCatalog {
  id             String   @id @default(cuid())
  moodleCourseId Int      @unique
  shortname      String
  fullname       String
  summary        String?
  categoryId     Int?
  categoryName   String?
  isVisible      Boolean  @default(true)
  price          Decimal  @default(0) @db.Decimal(10, 2)
  lastSyncedAt   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  cartItems      CartItem[]

  @@index([categoryId])
  @@index([isVisible])
}

model AdminActivityLog {
  id          String      @id @default(cuid())
  adminUserId String
  targetUserId String?
  action      AdminAction
  details     Json?
  createdAt   DateTime    @default(now())
  adminUser   User        @relation("AdminActivityActor", fields: [adminUserId], references: [id], onDelete: Cascade)
  targetUser  User?       @relation("AdminActivityTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([adminUserId, createdAt])
  @@index([targetUserId, createdAt])
  @@index([createdAt])
}

model CartItem {
  id             String   @id @default(cuid())
  userId         String
  courseId       String
  quantity       Int      @default(1)
  addedAt        DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         CourseCatalog @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Coupon {
  id             String   @id @default(cuid())
  code           String   @unique
  discountType   CouponType
  discountValue  Decimal  @db.Decimal(10, 2)
  minPurchase    Decimal  @default(0) @db.Decimal(10, 2)
  maxUsage       Int?
  currentUsage   Int      @default(0)
  isActive       Boolean  @default(true)
  expiresAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

model ParentChild {
  id        String   @id @default(cuid())
  parentId  Int      // Moodle User ID of parent
  childId   Int      // Moodle User ID of student
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
}

model RegistrationRole {
  id        String   @id @default(cuid())
  username  String   @unique
  role      UserRole
  createdAt DateTime @default(now())

  @@index([username])
}

model SchoolLicense {
  id             String   @id @default(cuid())
  schoolId       Int      // Moodle User ID of the school
  moodleCourseId Int      // Moodle Course ID the license is for
  totalSeats     Int
  usedSeats      Int      @default(0)
  purchaseDate   DateTime @default(now())
  expiresAt      DateTime?
  
  assignments    LicenseSeatAssignment[]

  @@unique([schoolId, moodleCourseId])
  @@index([schoolId])
  @@index([moodleCourseId])
}

model LicenseSeatAssignment {
  id              String        @id @default(cuid())
  licenseId       String
  studentId       Int           // Moodle User ID of the assigned student
  assignedAt      DateTime      @default(now())
  
  license         SchoolLicense @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, studentId])
  @@index([licenseId])
  @@index([studentId])
}

enum FormType {
  CONTACT
  TEACHER_APPLICATION
  CUSTOM
}

enum FieldType {
  TEXT
  EMAIL
  TEXTAREA
  PHONE
  SELECT
  CHECKBOX
  RADIO
  FILE
  DATE
  NUMBER
}

model Form {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        FormType
  isActive    Boolean  @default(true)
  createdBy   String   // User ID of form creator
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  fields      FormField[]
  submissions FormSubmission[]

  @@index([type])
  @@index([isActive])
  @@index([createdAt])
}

model FormField {
  id          String   @id @default(cuid())
  formId      String
  fieldType   FieldType
  label       String
  placeholder String?
  isRequired  Boolean  @default(false)
  order       Int
  options     String?  // JSON array for select/radio options
  validation  String?  // JSON validation rules
  
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([order])
}

model FormSubmission {
  id          String   @id @default(cuid())
  formId      String
  submitBy    String?  // User ID if logged in, email if guest
  email       String?
  data        Json     // Form field values
  status      String   @default("submitted") // submitted, reviewing, approved, rejected
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  files       SubmissionFile[]

  @@index([formId])
  @@index([submitBy])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model SubmissionFile {
  id            String   @id @default(cuid())
  submissionId  String
  originalName  String
  storageName   String
  mimeType      String
  size          Int      // File size in bytes
  uploadedAt    DateTime @default(now())
  
  submission    FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([uploadedAt])
}

model SupportTicket {
  id                 String                @id @default(cuid())
  ticketNumber       String                @unique
  subject            String
  description        String
  category           SupportTicketCategory
  priority           SupportTicketPriority @default(MEDIUM)
  status             SupportTicketStatus   @default(OPEN)
  createdByUserId    String
  assignedToUserId   String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  firstResponseAt    DateTime?
  closedAt           DateTime?
  firstResponseDueAt DateTime
  resolutionDueAt    DateTime?
  lastRepliedAt      DateTime?
  lastReplyByUserId  String?

  createdByUser      User                  @relation("SupportTicketCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  assignedToUser     User?                 @relation("SupportTicketAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  lastReplyByUser    User?                 @relation("SupportTicketLastReplyBy", fields: [lastReplyByUserId], references: [id], onDelete: SetNull)
  messages           SupportTicketMessage[]
  attachments        SupportTicketAttachment[]
  notifications      SupportTicketNotification[]

  @@index([createdByUserId, createdAt])
  @@index([assignedToUserId, updatedAt])
  @@index([status, priority, updatedAt])
  @@index([category, createdAt])
}

model SupportTicketMessage {
  id           String                  @id @default(cuid())
  ticketId     String
  authorUserId String
  message      String
  isInternal   Boolean                 @default(false)
  createdAt    DateTime                @default(now())

  ticket       SupportTicket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  authorUser   User                    @relation("SupportTicketMessageAuthor", fields: [authorUserId], references: [id], onDelete: Cascade)
  attachments  SupportTicketAttachment[]

  @@index([ticketId, createdAt])
  @@index([authorUserId, createdAt])
}

model SupportTicketAttachment {
  id               String                @id @default(cuid())
  ticketId         String
  messageId        String?
  uploadedByUserId String
  originalName     String
  storageName      String
  mimeType         String
  size             Int
  uploadedAt       DateTime              @default(now())

  ticket           SupportTicket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message          SupportTicketMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  uploadedByUser   User                  @relation("SupportTicketAttachmentUploader", fields: [uploadedByUserId], references: [id], onDelete: Cascade)

  @@index([ticketId, uploadedAt])
  @@index([messageId, uploadedAt])
  @@index([uploadedByUserId, uploadedAt])
}

model SupportTicketNotification {
  id        String        @id @default(cuid())
  ticketId  String
  userId    String
  type      String
  message   String
  isRead    Boolean       @default(false)
  createdAt DateTime      @default(now())
  readAt    DateTime?

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
  @@index([userId, isRead, createdAt])
}
